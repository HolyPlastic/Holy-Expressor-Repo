<!DOCTYPE html>
<html>


 <!-- #region 🔽🔽🔽 LOADING + head 🗿===================================------------------
____________________ -------->  
<head>
  <meta charset="UTF-8" />
  <title>Holy Expressor</title>

  <!-- 🧩 CSS FIRST: ensures styled paint before JS -->
  <link rel="stylesheet" href="css/styles.css" />

<!-- #region 🎨⚙️⚙️ CSS STYLE FUNCTION ===================================------------------>

<script>
(function STYLE_boot(){
  try {
    const theme = localStorage.getItem('he_theme') || 'default';
    document.documentElement.classList.add(`theme-${theme}`);

    // 💡 HEX → RGB
    function hexToRgb(hex) {
      const clean = hex.replace('#', '');
      const bigint = parseInt(clean, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return { r, g, b };
    }

    // 💡 RGB → HSL
    function rgbToHsl(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;

      if (max === min) {
        h = s = 0; // gray
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h /= 6;
      }

      return {
        h: Math.round(h * 360),
        s: Math.round(s * 100),
        l: Math.round(l * 100)
      };
    }

    // 🧮 Read CSS var, convert, and reassign
    const root = document.documentElement;
    const hex = getComputedStyle(root).getPropertyValue('--G-color-1').trim();
    const { r, g, b } = hexToRgb(hex);
    const { h, s, l } = rgbToHsl(r, g, b);

    // ✅ Preserve existing RGB pipeline (for opacity borders etc.)
    root.style.setProperty('--G-colour-1-RGB', `${r}, ${g}, ${b}`);

    // ✅ Add new HSL variables for CSS-controlled modifiers
    root.style.setProperty('--G-color-1-H', h);
    root.style.setProperty('--G-color-1-S', s + '%');
    root.style.setProperty('--G-color-1-L', l + '%');

  } catch (e) {
    console.warn('cy_styleBoot failed', e);
  }
})();
</script>
<!----_-_-_-_-_-_-_---------------------------------------\--\--->
<!-- #endregion ^^^ end🎨⚙️⚙️ ^^^ -->


  

  <!-- ⚙️ Core CEP dependencies (MUST stay synchronous) -->
  <script src="js/libs/CSInterface.js"></script>
  <script src="js/json2.js"></script>

  <!-- 🧠 Core editor bundle (CodeMirror) -->
  <script defer src="js/codemirror/codemirror-bundle.js"></script>
<!-- 💡 CM bundle is loaded above -->
<link rel="stylesheet" href="css/codemirror_styles.css"> <!-- uses globals from styles.css -->
  <!-- 🧩 Plugin modules (safe to defer) -->
  <script defer src="js/main_UTILS.js"></script>
  <script defer src="js/main_STATE.js"></script>
  <script defer src="js/main_FLYO.js"></script>
  <script defer src="js/main_MENU.js"></script>
  <script defer src="js/main_UI.js"></script>
  <script defer src="js/main_EXPRESS.js"></script>
  <script defer src="js/main_BUTTON_LOGIC_1.js"></script>
  <script defer src="js/main_SNIPPETS.js"></script>
  <script defer src="js/main_SEARCH_REPLACE.js"></script>
  <script defer src="js/main_DEV_INIT.js"></script>

  <!-- 🚀 Final entrypoint -->
  <script defer src="js/main.js"></script>
</head>



<body>

  <div id="appRoot">
  
  <header class="hdr hide-when-editor-maximized">
    <h2></h2>
  </header>



  <section class="tabs hide-when-editor-maximized">
   
 <!-- V1 — Flyover Trigger Button -->

        <button class="tab-btn" id="reloadPanel">Reload</button>
  <button  class="tab-btn" id="exposeBtn">Expose</button>

  <button id="quickAccessLaunchBtn" class="tab-btn">Quickpanel</button>


  </section>

<!----_-_-_-_-_-_-_---------------------------------------\--\--->
<!-- #endregion ^^^ EnndLoading 🔽 + head 🗿 ^^^ -->



<!-- #region ✂️✂️✂️ SNIPPETS ===================================------------------
____________________ -------->

  <!-- ============================ 
       ✂️✂️✂️✂️SNIPPETS
       ============================ -->


<!-- V1: Snippets Bar (single button) -->
<div id="snippetsBar" class="panel hide-when-editor-maximized">



<!-- 🟧 Bank Header Compact + Dropdown Icon -->
<div id="bankHeader" class=>
  <span class="heading-1 f18-c">Snippets </span>
  <!-- Dropdown button (icon version) -->
 
 
 
<button id="bankSelectBtn" class="btn-clearSVG" title="Select Bank">
    <svg viewBox="-0.55 -0.56 9.05 11.88" class="btn-icon">
      <path 
        d="M1.34,1.34h0c1.46-1.46,3.82-1.46,5.27,0h0c.7.7,1.09,1.65,1.09,2.64v2.82c0,.31-.12.61-.35.83l-2.55,2.55c-.46.46-1.21.46-1.67,0L.6,7.63c-.22-.22-.35-.52-.35-.83v-2.82c0-.99.39-1.94,1.09-2.64Z"
        fill="currentColor"
        stroke-miterlimit="10"

      ></path>
      <line class="inner-contents" x1="5.62" y1="6.85" x2="2.35" y2="3.58" 
        fill="none"
        stroke-linecap="round"
        stroke-linejoin="round"
      ></line>
      <line class="inner-contents" x1="4.03" y1="7.5" x2="2.56" y2="6.03"
        fill="none"
        stroke-linecap="round"
        stroke-linejoin="round"
      ></line>
      <line class="inner-contents" x1="5.38" y1="4.43" x2="3.92" y2="2.97" 
        fill="none"
        stroke-linecap="round"
        stroke-linejoin="round"
      ></line>
    </svg>
  </button>

  <!-- Bank name (editable text) -->
  <span id="bankNameLabel" class="f18-c">Bank 1</span>



  <!-- Context menu for bank actions -->
  <ul id="bankSelectMenu" class="context-menu"></ul>
</div>


  <div class="snippetsRow" id="snippetsRow"></div>
  <label class="checkbox-label text-sm"><input type="checkbox" id="snipLoadControls"></label>
</div>

<!-- Context menu for snippet buttons -->
<ul id="snippetContextMenu" class="context-menu snippet-menu hide-when-editor-maximized">
  <li><button data-action="edit">Edit</button></li>
  <li><button data-action="express">Express...</button></li>
</ul>

<!----_-_-_-_-_-_-_---------------------------------------\--\--->
<!-- #endregion ^^^ End Snippets ✂️ ^^^ -->



  <!-- ============================
       Defunct tab section??-->
  <section id="expressions" class="tab active hide-when-editor-maximized">

  </section>

<!-- #region 🖥️🖥️🖥️ EXPRESS ===================================------------------
____________________ -------->


<!-- Express panel -->
<div id="expressArea" class="panel">
  <div class="express-panel-header">
    <span class="heading-1 f18">Express</span>
    <div class="express-panel-actions">
      <button id="editorMaximizeBtn" class="btn-discreet" type="button" aria-label="Maximize editor" aria-pressed="false" title="Maximize editor">
        <span class="icon icon-expand" aria-hidden="true">⤢</span>
        <span class="icon icon-collapse" aria-hidden="true">⤡</span>
        <span class="sr-only">Maximize editor</span>
      </button>
    </div>
  </div>
  <!-- V2: pick UI removed -->
  <!-- Editor row -->
  <div id="codeEditor"></div>
  <!-- Overlay action buttons anchored to the bottom-right of the Express area -->
  <div class="express-editor-overlay" role="group" aria-label="Editor quick actions">
    <button id="editorClearBtn" class="btn-clearSVG express-editor-overlay-btn" type="button" aria-label="Clear editor" title="Clear editor">
      <svg viewBox="-0.43 -0.42 25.71 52.68" class="btn-icon">
        <path
          d="M24.48,26.26c-9.38.66-14.29,6.21-23.15,25.2,7.75-19.06,7.67-24.83-.96-25.88,9.38-.66,14.29-6.21,23.15-25.2-7.75,19.06-7.67,24.83.96,25.88Z"
          fill="currentColor"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>
    <button id="loadPathFromSelectionBtn" class="btn-clearSVG express-editor-overlay-btn" type="button" aria-label="Load path from selection" title="Load path from selection">
      <svg viewBox="-0.42 -0.43 19.59 19.02" class="btn-icon">
        <path
          d="M18.37,9.67v8.12s-9.29,0-9.29,0L.52,9.22c-.09-.09-.14-.22-.14-.34V.86c0-.27.22-.49.49-.49h8.01c.13,0,.25.05.34.14l9.15,9.15Z"
          fill="currentColor"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width=".75"
        />
        <g>
          <line class="inner-contents"
            x1="5.9" y1="5.2" x2="12.85" y2="12.15"
            fill="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width=".75"
          />
          <circle class="inner-contents"
            cx="9.37" cy="8.67" r="1.88"
            fill="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width=".75"
          />
        </g>
      </svg>
    </button>
    <button id="loadFromSelectionBtn" class="btn-clearSVG express-editor-overlay-btn" type="button" aria-label="Load expression from selection" title="Load expression from selection">
      <svg viewBox="-0.42 -0.43 19.59 19.02" class="btn-icon">
        <path
          d="M18.37,9.67v8.12s-9.29,0-9.29,0L.52,9.22c-.09-.09-.14-.22-.14-.34V.86c0-.27.22-.49.49-.49h8.01c.13,0,.25.05.34.14l9.15,9.15Z"
          fill="currentColor"
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width=".75"
        />
        <g>
          <line class="inner-contents"
            x1="12.63" y1="8.09" x2="6.3" y2="8.09"
            fill="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width=".75"
          />
          <line class="inner-contents"
            x1="11.71" y1="10.26" x2="8.88" y2="10.26"
            fill="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width=".75"
          />
          <line class="inner-contents"
            x1="10.05" y1="5.99" x2="7.22" y2="5.99"
            fill="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width=".75"
          />
        </g>
      </svg>
    </button>
  </div>
</div>

<!----_-_-_-_-_-_-_---------------------------------------\--\--->
<!-- #endregion ^^^ End Express 🖥️ ^^^ -->


<!-- #region 🎛️🎛️🎛️ Express CONTROLS ===================================------------------
____________________ -------->


  <!-- =============== Main button Row ==============-->
	<!-- =======================[+]=====================-->
	
	
<div id="expressControls" class="express-controls">
    <div class="row btns">
<!--
  Target Selected button 
<div class="target-btn-wrapper">
  <button id="targetSelectedBtn" class="circle-btn"></button>
  <div class="label-under">Target<br>Selected</div>
</div>



<div class="target-btn-wrapper">
  <button id="targetSelectedBtn" class="circle-btn"></button>
  <div class="label-under">Target<br>Selected</div>
</div>

-->
  <!-- ============ Absolute vs Relative ☑️ ==============-->
	<!-- ======================[___?]=====================-->

</div>
    
<label class="checkbox-label text-sm"><input type="checkbox" id="useAbsoluteComp"> Use comp name instead of thisComp</label>


    <!-- ============ Custom Name Searching ☑️==============-->
	<!-- ======================[___?]=====================-->

    <!-- Custom Search controls -->
    <div class="row">
      <label class="checkbox-label text-sm">
  <input type="checkbox" id="useCustomSearch" /> Custom search
</label>
    </div>
    <div class="row">
      <input type="text" id="customSearch" placeholder="e.g. Stroke 1 > Opacity" disabled />
    </div>

</div>

<!----_-_-_-_-_-_-_---------------------------------------\--\--->
<!-- #endregion ^^^ End Controls ^^^ -->


<!-- #region 🔵🔵🔵 APPLY ===================================------------------
____________________ -------->


    <!-- Apply buttons -->
<div id="expressApplyRow" class="express-apply">
    <div class="row btns apply-row">
  


<!-- 🟧🟧🟧 Rhombus Button -->
<!-- 🟧 Unified rhombus button -->
<button id="applyBtn" class="btn-rhombus f18-c holy-glow">
  <svg class="rhombus-icon"
       xmlns="http://www.w3.org/2000/svg"
       width="63.25" height="20.08"
       viewBox="-0.75 -0.75 63.25 20.08">

    <!-- Left section -->
    <g class="rhombus-left">
      <path d="M7.47.5h-3.69C1.54.5-.04,2.69.67,4.82l3.69,11.02c.45,1.34,1.7,2.24,3.11,2.24" />
    </g>

    <!-- Middle section -->
    <g class="rhombus-mid">
      <rect x="7.47" y="0.5" width="46.8" height="18.08"
            fill="currentColor" stroke="none" />
      <line x1="7.47" y1="0.5"  x2="54.27" y2="0.5" />
      <line x1="7.47" y1="18.08" x2="54.27" y2="18.08" />
    </g>

    <!-- Right section -->
    <g class="rhombus-right">
      <path d="M54.27,18.08h3.69c2.24,0,3.82-2.19,3.11-4.32L57.38,2.74C56.93,1.4,55.68.5,54.27.5" />
    </g>
  </svg>

  <span class="label">APPLY</span>
</button>

      <!--<button id="applyTargetBtn" class="apply-target-btn">Apply</button>-->
    </div>
</div>

  <!-- ================ Romby boi ==============-->
	<!-- =======================[+]=====================-->


    
<!----_-_-_-_-_-_-_---------------------------------------\--\--->
<!-- #endregion ^^^ End Apply 🔵 ^^^ -->


<!-- #region ⚪⚪⚪ MISC ===================================------------------
____________________ -------->




    <!-- Apply Report toggle + box -->
<div id="expressMisc" class="express-misc">
    <div class="row">
      <button id="openApplyLog" class="log-button text-sm" title="Open Apply Log">Log</button>
      <button id="openThemePicker" class="btn-theme text-sm" title="Adjust Theme Color">Theme</button>
    </div>

    <div id="colorPickerOverlay" class="holy-color-overlay is-hidden" tabindex="-1" aria-hidden="true"></div>
    <div id="colorPickerModal" class="holy-color-modal is-hidden" role="dialog" aria-modal="true" aria-label="Theme Color Picker">
      <div class="holy-color-picker">
        <input type="text" class="color-input" id="themeColorInput" value="#1EFFD6" maxlength="7" autocomplete="off" spellcheck="false" />
        <canvas class="color-area" id="themeColorCanvas" width="220" height="140"></canvas>
        <input type="range" class="hue-slider" id="themeHueSlider" min="0" max="360" value="0" />
        <div class="picker-actions">
          <button type="button" class="btn-apply">Apply</button>
          <button type="button" class="btn-cancel">Cancel</button>
        </div>
      </div>
    </div>









<!-- Target box
    <div id="TargetBox" class="panel shade-hard">
    <div id="TargetList">No results yet</div>
    </div>
 -->
  <!-- Toast -->
  <footer id="toast"></footer>



    <!-- V2: pick UI removed -->


 <!----_-_-_-_-_-_-_---------------------------------------\--\--->
<!-- #endregion ^^^ End Misc ⚪ ^^^ -->

  </div>

  <div id="searchReplacePanel" class="panel search-replace-panel hide-when-editor-maximized">
    <label for="searchField" class="text-sm block-label">Search</label>
    <input type="text" id="searchField" class="text-input" />
    <label for="replaceField" class="text-sm block-label">Replace</label>
    <input type="text" id="replaceField" class="text-input" />
    <div class="row search-options">
      <label class="checkbox-label text-sm">
        <input type="checkbox" id="matchCase" checked /> Match case
      </label>
    </div>
    <button id="runSearchReplace" class="tab-btn">Run Search &amp; Replace</button>
  </div>

  </div> <!-- end appRoot -->


 <script>
(function holyThemePicker() {
  'use strict';

  const themeButton = document.getElementById('openThemePicker');
  const modal = document.getElementById('colorPickerModal');
  const overlay = document.getElementById('colorPickerOverlay');
  const colorInput = document.getElementById('themeColorInput');
  const hueSlider = document.getElementById('themeHueSlider');
  const canvas = document.getElementById('themeColorCanvas');
  if (!themeButton || !modal || !overlay || !colorInput || !hueSlider || !canvas) {
    return;
  }

  const applyButton = modal.querySelector('.btn-apply');
  const cancelButton = modal.querySelector('.btn-cancel');
  const ctx = canvas.getContext('2d');
  if (!applyButton || !cancelButton || !ctx) {
    return;
  }
  const root = document.documentElement;

  const CANVAS_WIDTH = canvas.width;
  const CANVAS_HEIGHT = canvas.height;

  let gradientImageData = null;
  let lastValidHex = '#1EFFD6';
  let initialHex = '#1EFFD6';
  let isDragging = false;
  let activePointerId = null;

  const state = {
    h: 180,
    s: 100,
    l: 50
  };

  function clamp(value, min, max) {
    return Math.min(Math.max(value, min), max);
  }

  function componentToHex(component) {
    const hex = clamp(Math.round(component), 0, 255).toString(16).padStart(2, '0');
    return hex.toUpperCase();
  }

  function rgbToHex(r, g, b) {
    return `#${componentToHex(r)}${componentToHex(g)}${componentToHex(b)}`;
  }

  function hexToRgb(hex) {
    if (typeof hex !== 'string') {
      return { r: 0, g: 0, b: 0 };
    }
    const normalized = hex.trim().replace('#', '');
    if (!normalized) {
      return { r: 0, g: 0, b: 0 };
    }
    const expanded = normalized.length === 3
      ? normalized.split('').map((c) => c + c).join('')
      : normalized.padEnd(6, '0');
    const value = parseInt(expanded, 16);
    const r = (value >> 16) & 255;
    const g = (value >> 8) & 255;
    const b = value & 255;
    return { r, g, b };
  }

  function rgbToHsl(r, g, b) {
    r /= 255;
    g /= 255;
    b /= 255;

    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    let h = 0;
    let s = 0;
    const l = (max + min) / 2;

    if (max !== min) {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r:
          h = (g - b) / d + (g < b ? 6 : 0);
          break;
        case g:
          h = (b - r) / d + 2;
          break;
        case b:
          h = (r - g) / d + 4;
          break;
        default:
          h = 0;
      }
      h /= 6;
    }

    return {
      h: Math.round(h * 360),
      s: Math.round(s * 100),
      l: Math.round(l * 100)
    };
  }

  function hslToRgb(h, s, l) {
    const hue = ((h % 360) + 360) % 360;
    const sat = clamp(s / 100, 0, 1);
    const lig = clamp(l / 100, 0, 1);

    if (sat === 0) {
      const gray = Math.round(lig * 255);
      return { r: gray, g: gray, b: gray };
    }

    const c = (1 - Math.abs(2 * lig - 1)) * sat;
    const x = c * (1 - Math.abs(((hue / 60) % 2) - 1));
    const m = lig - c / 2;

    let r1 = 0;
    let g1 = 0;
    let b1 = 0;

    if (hue < 60) {
      r1 = c; g1 = x; b1 = 0;
    } else if (hue < 120) {
      r1 = x; g1 = c; b1 = 0;
    } else if (hue < 180) {
      r1 = 0; g1 = c; b1 = x;
    } else if (hue < 240) {
      r1 = 0; g1 = x; b1 = c;
    } else if (hue < 300) {
      r1 = x; g1 = 0; b1 = c;
    } else {
      r1 = c; g1 = 0; b1 = x;
    }

    const r = Math.round((r1 + m) * 255);
    const g = Math.round((g1 + m) * 255);
    const b = Math.round((b1 + m) * 255);

    return { r, g, b };
  }

  function normalizeHex(value) {
    if (typeof value !== 'string') {
      return null;
    }
    const trimmed = value.trim();
    const sixMatch = trimmed.match(/^#?([0-9a-fA-F]{6})$/);
    if (sixMatch) {
      return `#${sixMatch[1].toUpperCase()}`;
    }
    const shortMatch = trimmed.match(/^#?([0-9a-fA-F]{3})$/);
    if (shortMatch) {
      const shortHex = shortMatch[1];
      const expanded = shortHex.split('').map((ch) => ch + ch).join('').toUpperCase();
      return `#${expanded}`;
    }
    const rgbMatch = trimmed.match(/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})/i);
    if (rgbMatch) {
      const r = clamp(parseInt(rgbMatch[1], 10), 0, 255);
      const g = clamp(parseInt(rgbMatch[2], 10), 0, 255);
      const b = clamp(parseInt(rgbMatch[3], 10), 0, 255);
      return rgbToHex(r, g, b);
    }
    return null;
  }

  function getCurrentCssColor() {
    const value = getComputedStyle(root).getPropertyValue('--G-color-1');
    return normalizeHex(value) || '#1EFFD6';
  }

  function updateDerivedVariables(hex) {
    const { r, g, b } = hexToRgb(hex);
    const { h, s, l } = rgbToHsl(r, g, b);
    root.style.setProperty('--G-colour-1-RGB', `${r}, ${g}, ${b}`);
    root.style.setProperty('--G-color-1-H', h);
    root.style.setProperty('--G-color-1-S', `${s}%`);
    root.style.setProperty('--G-color-1-L', `${l}%`);
  }

  function applyColor(hex) {
    const normalized = normalizeHex(hex) || '#1EFFD6';
    root.style.setProperty('--G-color-1', normalized);
    updateDerivedVariables(normalized);
  }

  function rebuildGradient() {
    const imageData = ctx.createImageData(CANVAS_WIDTH, CANVAS_HEIGHT);
    const hue = state.h;

    for (let y = 0; y < CANVAS_HEIGHT; y += 1) {
      const lightness = 100 - (y / (CANVAS_HEIGHT - 1)) * 100;
      for (let x = 0; x < CANVAS_WIDTH; x += 1) {
        const saturation = (x / (CANVAS_WIDTH - 1)) * 100;
        const { r, g, b } = hslToRgb(hue, saturation, lightness);
        const index = (y * CANVAS_WIDTH + x) * 4;
        imageData.data[index] = r;
        imageData.data[index + 1] = g;
        imageData.data[index + 2] = b;
        imageData.data[index + 3] = 255;
      }
    }

    gradientImageData = imageData;
  }

  function drawIndicator() {
    const indicatorX = (state.s / 100) * (CANVAS_WIDTH - 1);
    const indicatorY = (1 - state.l / 100) * (CANVAS_HEIGHT - 1);

    ctx.beginPath();
    ctx.arc(indicatorX, indicatorY, 6, 0, Math.PI * 2);
    ctx.fillStyle = '#00000055';
    ctx.fill();
    ctx.lineWidth = 1.5;
    ctx.strokeStyle = '#FFFFFF';
    ctx.stroke();
  }

  function renderCanvas() {
    if (!gradientImageData) {
      rebuildGradient();
    }
    if (gradientImageData) {
      ctx.putImageData(gradientImageData, 0, 0);
    }
    drawIndicator();
  }

  function getCurrentHex() {
    const { r, g, b } = hslToRgb(state.h, state.s, state.l);
    return rgbToHex(r, g, b);
  }

  function updateColorFromState() {
    const hex = getCurrentHex();
    lastValidHex = hex;
    colorInput.value = hex;
    renderCanvas();
    applyColor(hex);
  }

  function setStateFromHex(hex) {
    const normalized = normalizeHex(hex);
    if (!normalized) {
      return;
    }
    const { r, g, b } = hexToRgb(normalized);
    const { h, s, l } = rgbToHsl(r, g, b);
    state.h = h;
    state.s = s;
    state.l = l;
    hueSlider.value = String(h);
    gradientImageData = null;
    updateColorFromState();
  }

  function handlePointerUpdate(event) {
    const rect = canvas.getBoundingClientRect();
    const xRatio = clamp((event.clientX - rect.left) / rect.width, 0, 1);
    const yRatio = clamp((event.clientY - rect.top) / rect.height, 0, 1);
    state.s = xRatio * 100;
    state.l = 100 - yRatio * 100;
    updateColorFromState();
  }

  function handleCanvasPointerDown(event) {
    event.preventDefault();
    isDragging = true;
    activePointerId = event.pointerId;
    canvas.setPointerCapture(activePointerId);
    handlePointerUpdate(event);
  }

  function handleCanvasPointerMove(event) {
    if (!isDragging || event.pointerId !== activePointerId) {
      return;
    }
    handlePointerUpdate(event);
  }

  function handleCanvasPointerUp(event) {
    if (event.pointerId === activePointerId) {
      isDragging = false;
      canvas.releasePointerCapture(activePointerId);
      activePointerId = null;
    }
  }

  function openModal() {
    initialHex = getCurrentCssColor();
    lastValidHex = initialHex;
    setStateFromHex(initialHex);

    overlay.classList.remove('is-hidden');
    overlay.setAttribute('aria-hidden', 'false');
    modal.classList.remove('is-hidden');
    modal.setAttribute('aria-hidden', 'false');
    themeButton.setAttribute('aria-expanded', 'true');

    requestAnimationFrame(() => {
      colorInput.focus();
      colorInput.select();
    });

    document.addEventListener('keydown', handleKeydown, true);
  }

  function closeModal(options) {
    const { revert = false } = options || {};
    if (revert) {
      setStateFromHex(initialHex);
    }

    if (activePointerId !== null) {
      try {
        canvas.releasePointerCapture(activePointerId);
      } catch (err) {
        /* noop */
      }
    }
    isDragging = false;
    activePointerId = null;

    overlay.classList.add('is-hidden');
    overlay.setAttribute('aria-hidden', 'true');
    modal.classList.add('is-hidden');
    modal.setAttribute('aria-hidden', 'true');
    themeButton.setAttribute('aria-expanded', 'false');
    colorInput.blur();

    document.removeEventListener('keydown', handleKeydown, true);
  }

  function handleKeydown(event) {
    if (event.key === 'Escape') {
      event.preventDefault();
      closeModal({ revert: true });
    } else if (event.key === 'Enter' && event.target === colorInput) {
      event.preventDefault();
      applyButton.click();
    }
  }

  function toggleModal() {
    if (modal.classList.contains('is-hidden')) {
      openModal();
    } else {
      closeModal({ revert: true });
    }
  }

  themeButton.addEventListener('click', (event) => {
    event.preventDefault();
    toggleModal();
  });

  overlay.addEventListener('click', () => {
    closeModal({ revert: true });
  });

  applyButton.addEventListener('click', () => {
    initialHex = lastValidHex;
    closeModal({ revert: false });
  });

  cancelButton.addEventListener('click', () => {
    closeModal({ revert: true });
  });

  hueSlider.addEventListener('input', () => {
    state.h = parseFloat(hueSlider.value) || 0;
    gradientImageData = null;
    updateColorFromState();
  });

  colorInput.addEventListener('input', () => {
    const normalized = normalizeHex(colorInput.value);
    if (normalized) {
      setStateFromHex(normalized);
    }
  });

  colorInput.addEventListener('blur', () => {
    colorInput.value = lastValidHex;
  });

  canvas.addEventListener('pointerdown', handleCanvasPointerDown);
  canvas.addEventListener('pointermove', handleCanvasPointerMove);
  canvas.addEventListener('pointerup', handleCanvasPointerUp);
  canvas.addEventListener('pointercancel', handleCanvasPointerUp);
  canvas.addEventListener('pointerleave', handleCanvasPointerUp);

  // Initialize modal state without opening it so controls match the current theme.
  initialHex = getCurrentCssColor();
  lastValidHex = initialHex;
  setStateFromHex(initialHex);
})();
</script>

 <script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Holy Expressor Base Path →', window.location.href);
  });
</script>

</body>

</html>
